<!DOCTYPE html>
<meta charset="utf-8">
<style> 

.title {
	font: 15px sans-serif;
}

.legend {
	font: 10px sans-serif;
}
.axis path,
.axis line {
	fill: none;
	stroke: #000;
	shape-rendering: crispEdges;
}

.x.axis.path {
	display: none;
}

.line {
  fill: none;
  stroke: #be2f3e;
  stroke-width: 3px;
}

.positive_bar{	
	opacity: .4;
}

.negative_bar{
	opacity: .4;
}

.y.axis path{
	display: none;
}
</style>
<body>
<script src="https://d3js.org/d3.v4.min.js"></script>

<script> 

	var positiveColor = '#38e88f';
	var negativeColor = '#be2f3e';
	var lineColor = '#be2f3e';

	var margin = {top: 20, right: 20, bottom: 30, left: 40};
	var width = 960 - margin.left - margin.right;
	var height = 500 - margin.top - margin.bottom;

	var timeFormat = d3.timeFormat("%d-%m");	
	var parseDate  = d3.timeParse("%Y:%m");
	var x = d3.scaleBand().range([0, width]).padding(0.1);

	var y = d3.scaleLinear().range([height, margin.top]);
	var y1 = d3.scaleLinear().range([height,margin.top]);  // y - axis for line chart

	var center = d3.scaleLinear().range([0, width]);

	var color = d3.scaleOrdinal()
		.range(["#D9FBEA", "#055C81", "#B13C3D", "#CCB40C"]);

	var xAxis = d3.axisBottom(x).ticks(10).tickSizeOuter(0);
	var yAxis = d3.axisLeft(y).tickSize(0);

	var centerLine = d3.axisTop(center).ticks(0);


	// d3.json("https://dev.decryptz.com/api/v1/charts/implied_price", function(error, data) {
	d3.json("data2.json", function(error, data) {

		data = data.slice(data.length - 125, data.length );

		// data.sort()
		var keys = d3.keys(data[0]);

		// var keys = keys.filter(function(key) { 
		// 	if (key !== "id" && key !== "diffusion" && key !== "date" && key !== "cfnai" && key !== "cfnai_ma3") {
		// 		return key; 
		// 	}  
		// });


		var keys = ['z'];
		data.forEach(function(d) {
			var y0_positive = 0;
			var y0_negative = 0;			
			d.x = timeFormat(Date.parse(d.x));					
			// d.components = keys.map(function(key) {
			// 	if (d[key] >= 0) {
			// 		return {key: key, y1: y0_positive, y0: y0_positive += d[key] };
			// 	} else if (d[key] < 0) {
			// 		return {key: key, y0: y0_negative, y1: y0_negative += d[key] };
			// 	}
			// })
			d.z = + d.z;
		})

		var y_min = d3.min(data, function(d) { return d.z -5});
		var y_max = d3.max(data, function(d) { return d.z +5});

		var datestart = d3.min(data, function(d) { return parseDate(d.x); });
		var dateend = d3.max(data, function(d) { return parseDate(d.x);});

		// x.domain([datestart, dateend]);
		x.domain(data.map(function(d) { return d.x; }));	
		y.domain([y_min, y_max]);
		
		var y1_min = d3.min(data,function(d){return d.y});
		var y1_max = d3.max(data,function(d){return d.y});

		y1.domain([y1_min,y1_max]);

		color.domain(keys);

		var price_line = d3.line()
			.x(function(d) { return x(d.x) + x.bandwidth()/2; })
			.y(function(d) { return y1(d.y); });

		var svg = d3.select("body").append("svg")
									.attr("width", width + margin.left + margin.right)
									.attr("height", height + margin.top + margin.bottom)
									.append("g")
									.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		svg.append("g")
			.attr("class", "x axis")
			.attr("transform", "translate(0," + height + ")")
			.call(xAxis);

		svg.append("g")
			.attr("class", "y axis")
			.call(yAxis);

		svg.append("g")
			.attr("class", "centerline")
			.attr("transform", "translate(0," + y(0) + ")")
			.call(centerLine);

		// var entry = svg.selectAll(".entry")
		// 	.data(data)
		// 	.enter().append("g")
		// 	.attr("class", "g")
		// 	.attr("transform", function(d) { return "translate(" + x(d.x) + ", 0)"; });

		svg.selectAll("rect")
			.data(data).enter()
			.append("rect")
			.attr('class',function(d){
				if(d.z>0){
					return 'positive_bar';
				}
				return 'negative_bar';
			})
			.attr("width", x.bandwidth())
			.attr('x',function(d){return x(d.x)})			
			.attr("y", function(d) {if(d.z > 0) return y(d.z); return y(0)})
			.attr("height", function(d) { return Math.abs(y(0) - y(d.z)); })
			.style("fill", function(d) { if(d.z > 0 ) return positiveColor; return negativeColor;} );

	  svg.append("path")
		    .data([data])
		    .attr("class", "line")
		    .attr("d", price_line);
	})

</script>